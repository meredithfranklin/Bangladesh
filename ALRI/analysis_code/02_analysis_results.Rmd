---
title: "02_analysis_results"
output: html_document
---

```{r}
objs <- readRDS("analysis_objects.rds")

final_df <- objs$final_df
first_event_df <- objs$first_event_df
baseline_df_child <- objs$baseline_df_child
baseline_df_mom <- objs$baseline_df_mom

library(splines)
```


## Model

### Cox Model for compressed data

#### Univariate Cox models 

```{r factor_recode}
# Variables to be treated as categorical
factor_vars <- c(
  "area", "kchnloc1","Tstv","sex","wkupfreq","prstyaslp","coughm","coughd_n","phlmm","phlmd_n", "tghtnschst","kro","cook_t","mdiab","mhrtds","lowses","highses","wi5","ap","cycle","fan","fridge","mtcycle","bullcrt","boat","KchnOpen","KchnOwRf","KchnSep","KchnOth","floorB","lpelectricity","mcoil1","cndle1","kchnloc", "cookloc", "typkchn","smkothkch","smkind","msqtcoil","dhup","kupi", "trdaftslp","snore","whzng","asthatt","shrtbreath","prghyp","deltyp","nofetus","lqdbfrm","brstm","frstbrstm","tmcry","sick","lbw","pump"
)

first_event_df <- first_event_df %>%
  mutate(across(all_of(factor_vars), as.factor))

# Recode horse to 2 levels, dropping the NA level 
first_event_df$horse[first_event_df$horse == "."] <- NA
first_event_df$horse <- as.numeric(as.character(first_event_df$horse))
first_event_df$horse <- factor(first_event_df$horse, levels = c(0, 1))

# Sanity check 
final_df %>%
  group_by(C_ID) %>%
  slice(1) %>%                           
  summarise(horse = first(horse)) %>%    
  count(horse)                           

first_event_df %>%
  summarise(horse) %>% 
  count(horse)
```

```{r}
# Univariate Cox models for candidate covariates
vars <- c( "sex", "area", "kchnloc1", "m_age", "bmi","Tstv","wi", "fuelT", "tbc", "toilet_S", "pulse", "diastolic", "systolic","cook_t","lcm1" , "wtkg1","hccm1", "gadel", "mdiab", "mhrtds","kro", "lowses","highses", "husprof","wi5", "ap","ga", "medu","fridge","fan","cycle", "mtcycle","bullcrt","boat","Tubewel","muslim","Bangla", "wtrPipeRm", "wtrPipeH","KchnOpen","KchnOwRf","KchnSep","KchnOth","floorB","Upzilla","UnionCd","TypFam","M_tng","Rlgn","race","mage_cat","hedu","ethnicity","religion1","scndsmk", "mheightm","bmicat","lpelectricity","mcoil1","cndle1","kchnloc","cookloc","typkchn","smkothkch","smkind","msqtcoil","dhup","kupi","wkupfreq","prstyaslp","trdaftslp","snore","coughm","coughd_n","phlmm","phlmd_n","whzng","asthatt","tghtnschst","shrtbreath","prghyp","deltyp","wtcali","nofetus","lqdbfrm","brstm","frstbrstm","tmcry","sick","lbw","ChldUn5","elect","TV","mobile","pump","clock","autmob","goat","lamb","horse","plowland","fishpond","M_pHW","M_pTailor","M_pSt","M_pJob","M_pOth","H_pOwnAg","h_pBorga" ,"h_pAgL","h_pGJ", "h_pPJ", "h_pL", "H_pDoc","h_pBloan","h_pB","h_pHome","h_pTra", "h_pCons", "h_pShL","toilet_P","toilet_H","toilet_O","toilet","cow","SewMchn","NFmMbr","fthrsmk1" ,"sga")

# Cox Model
univ_results <- lapply(vars, function(v) {
  f <- as.formula(paste("Surv(tstart, tstop, status) ~", v))
  fit <- coxph(f, data = first_event_df)
  tidy(fit)  
})

# Results
univ_results_df <- do.call(rbind, univ_results)
univ_results_df
```

```{r}
# Variables with p < 0.2 in Univariate models
candidate_vars_p02 <- univ_results_df %>%
  filter(p.value < 0.2) %>%
  pull(term)

candidate_vars_p02

# Variables with p < 0.5 in Univariate models
candidate_vars_p05 <- univ_results_df %>%
  filter(p.value < 0.5) %>%
  pull(term)
candidate_vars_p05
```

```{r}
# Example Univariate Model 
cox_sex <- coxph(Surv(tstart, tstop, status) ~ sex, data = first_event_df)
summary(cox_sex)

AIC(cox_sex)
```
The hazard ratio for female children was 0.63, indicating a lower risk of first ALRI compared to males.

#### Multivariable Cox Models 

```{r}
# Multivariable Cox model with baseline covariates only
# Time-varying covariates were excluded from the first-event model

# Model 1: full model with all the variables p_value < 0.2 for univariate models
cox1 <- coxph(Surv(tstart, tstop, status) ~  
                sex + area + kchnloc1 + fuelT +  wtcali + tbc + wtkg1 + mheightm +smkothkch + cookloc+
                dhup + kupi + wkupfreq + snore + coughm +  coughd_n + phlmm +  phlmd_n + tghtnschst +
                lqdbfrm + horse + UnionCd, 
              
                data = first_event_df)
summary(cox1)
```

```{r}
vif(cox1)
```

Backward elimination was used to derive the final multivariable Cox model for time to first ALRI event, considering baseline confounders and overall model fit. Final model as follows: 

```{r cox_firstevent_final1}
cox_firstevent_final <- coxph(Surv(tstart, tstop, status) ~  
                sex + area + tbc + mheightm + wtkg1+  kupi + wkupfreq + coughd_n +  wtcali + lqdbfrm + horse,
                data = first_event_df)

summary(cox_firstevent_final)
```

##### PH assumption check

```{r}
# Test proportional hazards (PH) assumption using Schoenfeld residuals
cox.zph(cox_firstevent_final)
```
The proportional hazards assumption was assessed using Schoenfeld residuals.
The global test indicated evidence of deviation from proportional hazards (p = 0.016).
At the covariate level, area, coughd_n, and wtcali showed p-values below 0.05, suggesting potential time-varying effects. 

To further evaluate these findings, Schoenfeld residual plots were examined. (The closer the curves are to the horizontal straight line to 0, the better the PH assumption is satisfied.)
```{r}
plot(cox.zph(cox_firstevent_final))
```

Overall, the residual plots suggested modest departures from proportionality, with the most notable deviations observed for the area variable.

Sensitivity analysis with stratification:
Given the evidence of non-proportionality associated with area, a stratified Cox model was fitted, allowing the baseline hazard to vary across area strata.
```{r}
cox_firstevent_final2<- coxph(Surv(tstart, tstop, status) ~  
                sex + strata(area) + tbc + mheightm + wtkg1+  kupi + wkupfreq + coughd_n +  wtcali + lqdbfrm + horse,
                data = first_event_df)

summary(cox_firstevent_final2)
cox.zph(cox_firstevent_final2)
```

After stratification by area, the global Schoenfeld test was no longer statistically significant (p > 0.05), suggesting that the proportional hazards assumption was adequately satisfied in the stratified model.

##### Outcome Interpret

Female children had a significantly lower hazard of developing ALRI compared with male children (HR = 0.68,  95% CI = 0.49 - 0.94, p = 0.018), corresponding to a 32% reduction in risk.

Children exposed to oral tobacco consumption had a higher hazard of ALRI compared with those who were not exposed (HR = 1.46), indicating a 46% increase in risk. Children who experienced cough had a substantially higher hazard of developing ALRI compared with those without cough (HR = 1.56), representing a 56% increase in risk.
 
Maternal height was inversely associated with the hazard of ALRI. Each one-unit increase in maternal height (measured in meters) was associated with an approximately 89% reduction in the hazard of ALRI (HR = 0.11).

### Models for recurrent events

```{r}
# Mutate categorical variables into factors 
factor_vars_recurrent <- c(
  "area", "kchnloc1","Tstv","sex","wkupfreq","prstyaslp","coughm","coughd_n","phlmm","phlmd_n", "tghtnschst","kro","cook_t","mdiab","mhrtds","lowses","highses","wi5","ap","cycle","fan","fridge","mtcycle","bullcrt","boat","KchnOpen","KchnOwRf","KchnSep","KchnOth","floorB","lpelectricity","mcoil1","cndle1","kchnloc", "cookloc", "typkchn","smkothkch","smkind","msqtcoil","dhup","kupi", "trdaftslp","snore","whzng","asthatt","shrtbreath","prghyp","deltyp","nofetus","lqdbfrm","brstm","frstbrstm","tmcry","sick","lbw","pump","Diarrhea")

final_df <- final_df %>% 
  mutate(across(all_of(factor_vars_recurrent),as.factor))

final_df$horse[final_df$horse == "."] <- NA
final_df$horse <- as.numeric(as.character(final_df$horse))
final_df$horse <- factor(final_df$horse, levels = c(0, 1))
```

```{r}
# Remove invalid risk intervals (tstop <= tstart or missing times)
final_df %>%
  filter(tstop <= tstart | is.na(tstart) | is.na(tstop)) %>%
  arrange(C_ID, tstart) %>%
  select(C_ID, tstart, tstop, status)

final_df <- final_df %>%
  filter(tstop > tstart & !is.na(tstart) & !is.na(tstop))
```

```{r}
# Standardize continuous covariates for model stability
final_df <- final_df %>%
  mutate(
    wtkg1_z = scale(wtkg1),
    mheightm_z = scale(mheightm)
  )
```

```{r}
final_df %>% summarise(across(c(FastBreath, Diarrhea, FeverFr,Cough_cold), ~sum(.x==1, na.rm=T)))
```

##### Marginal means and rates model

```{r}
# Marginal means and rates model 
mmrm_full <- coxph(
  Surv(tstart, tstop, status) ~ 
    sex +area+ tbc + mheightm_z + wtkg1_z+  kupi + wkupfreq + coughd_n +  wtcali + lqdbfrm + horse + biomass + Diarrhea + Cough_cold + toilet_S + FeverFr + out.PM24 + Kch.PM24 + Bedroom.PM24 + cluster(C_ID),                   
  data = final_df,
  method = "breslow"
)

summary(mmrm_full)
AIC(mmrm_full)
```

The marginal means and rates model and the Andersen–Gill (AG) model yielded identical coefficient estimates, standard errors, and test statistics. This is expected because the marginal rate model is implemented through the Andersen–Gill counting-process formulation of the Cox proportional hazards model with robust variance estimation to account for within-child correlation. Therefore, the two models are mathematically equivalent and produce the same results in this analysis.

##### Andersen_Gill (AG) model 

```{r}
# AG full model 
ag_full <- coxph(
  Surv(tstart, tstop, status) ~ 
    sex +area+ tbc + mheightm_z + wtkg1_z+  kupi + wkupfreq + coughd_n +  wtcali + lqdbfrm + horse + biomass + Diarrhea + Cough_cold + toilet_S + FeverFr + out.PM24 + Kch.PM24 + Bedroom.PM24 
  +cluster(C_ID), 
    method = "breslow",
  robust = TRUE,
  data = final_df
)

summary(ag_full)
AIC(ag_full)
```

```{r}
# Recode clean variables for the model

# Construct a kupi level for only two levels : new_kupi
final_df <- final_df %>%
  mutate(
    new_kupi = case_when(
      kupi == 5 ~ 0,
      kupi %in% c(1, 2, 3, 4) ~ 1,
      TRUE ~ NA_real_
    )
  )

# First recode the wkupfreq variable into binary 
final_df <- final_df %>%
  mutate(
    new_wkupfreq = case_when(
      wkupfreq %in% c(1, 2)  ~ 0,
      wkupfreq %in% c(3, 4, 5, 6) ~ 1,
      TRUE ~ NA_real_
    )
  )

# First recode the dhup variable into binary 
final_df <- final_df %>%
  mutate(
    new_dhup = case_when(
      dhup == 5   ~ 0,
      dhup %in% c(1, 2, 3, 4) ~ 1,
      TRUE ~ NA_real_
    )
  )

# First recode the new_score variable into binary 
final_df <- final_df %>%
  mutate(
    new_snore = case_when(
      snore == 0  ~ 0,
      snore %in% c(1, 2, 3, 4) ~ 1,
      TRUE ~ NA_real_
    )
  )

# First recode the trdaftslp variable into binary 
final_df <- final_df %>%
  mutate(
    new_trdaftslp = case_when(
      trdaftslp %in% c(1, 2) ~ 0,
       trdaftslp %in% c(3, 4, 5, 6) ~ 1,
      TRUE ~ NA_real_
    )
  )

# Recode the mom age category variable into 3 levels 
final_df <- final_df %>%
  mutate(
    new_mage_cat = case_when(
      mage_cat == "<18 years"  ~ "<18 years",
      mage_cat %in% c("18-22 years", "23-25 years", "26-31 years","32-36 years") ~ "older",
      TRUE ~ NA_character_
    )
  )

# Recode mother education variable 
final_df$medu <- na_if(final_df$medu, ".")

final_df <- final_df %>%
  mutate(
    new_medu = case_when(
      medu == "No schooling" ~ "No schooling",
      medu %in% c("5–9 years", "10 years or more", "<5 years") ~ "Any schooling",
      TRUE ~ NA_character_
    ),
    new_medu = factor(new_medu)
  )


# Scale mheightm and wtkg1
iqr_mheightm <- IQR(final_df$mheightm, na.rm = TRUE)
iqr_wtkg1 <- IQR(final_df$wtkg1, na.rm = TRUE)
iqr_mheightm
iqr_wtkg1

final_df <- final_df %>%
mutate(
mheightm_iqr = mheightm / iqr_mheightm,
wtkg1_iqr = wtkg1 / iqr_wtkg1
)

# Child under 5 as continuous variables
final_df %>% 
  select(ChldUn5) %>% 
  distinct()

final_df$ChldUn5 <- as.numeric(final_df$ChldUn5)
```

A total of 24 iterations of variable inclusion and exclusion were conducted during model development. Variables with univariate p-values less than 0.20 were initially included, followed by backward selection. Variables with p-values less than 0.50 were subsequently added and backward selection was performed again. This iterative process resulted in the final Andersen–Gill model, which included a spline term for the 7-day rolling average of predicted PM2.5 exposure.

Spline term for final AG Model for 7 day rolling window

```{r}
# Final AG model with smooth term of 7 day rolling averages of PM2.5 predictions

png("AG_spline.png", width = 8, height = 5, units = "in", res = 300)

agfinal_spline_7d <- coxph(
  Surv(tstart, tstop, status) ~ 
    sex + area + mheightm_iqr + tbc + wtkg1_iqr + biomass + Diarrhea + toilet_S +
    new_mage_cat + kchnloc1 + sga  + 
    ChldUn5  + ga  +
    lqdbfrm  + ns(mean_pm25_predicted_7d, df = 4) +
    season+
    cluster(C_ID),
  data = final_df,
  method = "breslow"
)


k1_7d <- 56.61513
k2_7d <- 80.64067
k3_7d <- 131.12299

# termplot
term1 <- termplot(agfinal_spline_7d, se = TRUE, 
       terms = "ns(mean_pm25_predicted_7d, df = 4)",
                xlab = "",,
  ylab = "Partial log-hazard",
  col.term = "black",
  col.se = "grey60",
  lwd.term = 2,
  lwd.se = 1)

mtext(
  expression("7-day mean PM"[2.5] ~ "(" * mu * "g/m"^3 * ")"),
  side = 1,
  line = 3
)

title(
  main = expression("Estimated exposure–response curve for 7-day mean PM"[2.5]),
  cex.main = 1
)

mtext(
  "Natural spline with internal knots at 56.62, 80.64, and 131.12 µg/m³",
  side = 3,
  line = 0.3,
  cex = 0.8
)

abline(v = k1_7d, col = "royalblue4", lty = 2, lwd = 1.5)
abline(v = k2_7d, col = "royalblue4", lty = 2, lwd = 1.5)
abline(v = k3_7d, col = "royalblue4", lty = 2, lwd = 1.5)


text(k1_7d, par("usr")[4] * 0.90, paste0("K1=", round(k1_7d, 2)), 
     col = "royalblue4", cex = 0.8, pos = 4)
text(k2_7d, par("usr")[4] * 0.90, paste0("K2=", round(k2_7d, 2)), 
     col = "royalblue4", cex = 0.8, pos = 4)
text(k3_7d, par("usr")[4] * 0.90, paste0("K3=", round(k3_7d, 2)), 
     col = "royalblue4", cex = 0.8, pos = 4)



```

```{r}
tmp <- ns(final_df$mean_pm25_predicted_7d, df = 4)
attr(tmp, "knots")

# Extract knots 
k1_7d <- 56.61513
k2_7d <- 80.64067
k3_7d <- 131.12299

final_df <- final_df %>%
  mutate(
    pm1_7d = mean_pm25_predicted_7d,
    pm2_7d = (mean_pm25_predicted_7d - k1_7d) * (mean_pm25_predicted_7d >= k1_7d),
    pm3_7d = (mean_pm25_predicted_7d - k2_7d) * (mean_pm25_predicted_7d >= k2_7d),
    pm4_7d = (mean_pm25_predicted_7d - k3_7d) * (mean_pm25_predicted_7d >= k3_7d)
  )
```

```{r}
# Months with splines
agfinal_pw_7d_mon <- coxph(
  Surv(tstart, tstop, status) ~ 
    sex + area + mheightm_iqr + tbc + wtkg1_iqr + biomass + Diarrhea + toilet_S +
    new_mage_cat + kchnloc1 + sga  +
    ChldUn5 + 
    lqdbfrm  + pm1_7d+ pm2_7d + pm3_7d + pm4_7d +
    ns(month,df= 6)+
    cluster(C_ID),
  data = final_df,
  method = "breslow"
)
summary(agfinal_pw_7d_mon)
AIC(agfinal_pw_7d_mon)
```


```{r}
# Overall effect without applying non-linear spline 
agfinal_all_7d <- coxph(
  Surv(tstart, tstop, status) ~ 
    sex + area + mheightm_iqr + tbc + wtkg1_iqr + biomass + Diarrhea + toilet_S +
    new_mage_cat + kchnloc1 + sga  + 
    ChldUn5  + 
    lqdbfrm  + mean_pm25_predicted_7d +
    season +
    cluster(C_ID),
  data = final_df,
  method = "breslow"
)


summary(agfinal_all_7d)
AIC(agfinal_all_7d)
```

###### Final AG Model

```{r}
# Piecewise linear after setting the knots as threshold
agfinal_pw_7d <- coxph(
  Surv(tstart, tstop, status) ~ 
    sex + area + mheightm_iqr + tbc + wtkg1_iqr + biomass + Diarrhea + toilet_S +
    new_mage_cat + kchnloc1 + sga  + 
    ChldUn5  + 
    lqdbfrm  + pm1_7d+ pm2_7d + pm3_7d + pm4_7d +
    season +
    cluster(C_ID),
  data = final_df,
  method = "breslow"
)


summary(agfinal_pw_7d)
AIC(agfinal_pw_7d)
```


#### PWP-TT model

```{r}
final_df <- final_df %>%
  arrange(C_ID, tstop) %>%
  group_by(C_ID) %>%
  mutate(
    prior_events = cumsum(lag(status, default = 0)),
    at_risk_for = prior_events + 1
  ) %>%
  ungroup()

#sanity check 
final_df %>% 
  select(C_ID,tstart, tstop, status, prior_events, at_risk_for) %>% 
    filter(C_ID %in% c("0145C1", "0503C1","1209C1"))
```

###### Final PWP-TT Model 

```{r}
pwp_ttfinal_pw_7d <- coxph(
  Surv(tstart, tstop, status) ~ 
    sex + area + mheightm_iqr + tbc + wtkg1_iqr + biomass + Diarrhea + toilet_S +
    new_mage_cat + kchnloc1 + sga  + 
    ChldUn5 +
    lqdbfrm  + pm1_7d+ pm2_7d + pm3_7d + pm4_7d +
    ns(month,df= 6) +
    cluster(C_ID) + 
   strata(at_risk_for),
  data = final_df,
  method = "breslow"
)
summary(pwp_ttfinal_pw_7d)
AIC(pwp_ttfinal_pw_7d)
```

#### PWP-GT Model 

```{r}
# construct gap time 
final_df <- final_df %>%
  arrange(C_ID, tstop) %>%
  group_by(C_ID) %>%
  mutate(
    # when last time happened
    last_event_time = ifelse(lag(status, default = 0) == 1, 
                             lag(tstop, default = 0), 
                             NA),
    last_event_time = zoo::na.locf(last_event_time, na.rm = FALSE),
    last_event_time = ifelse(is.na(last_event_time), 0, last_event_time),
    gap_start = tstart - last_event_time,
    gap_stop = tstop - last_event_time
  ) %>%
  ungroup()
```

```{r}
#sanity check 
final_df %>% 
  select(C_ID,tstart, tstop, status,gap_start, gap_stop) %>% 
    filter(C_ID %in% c("0145C1", "0503C1","1209C1"))
```

###### Final PWP-GT Model

```{r}
# PWP-GT final model
pwp_gtfinal_pw_7d <- coxph(
  Surv(gap_start, gap_stop, status) ~ 
    sex + area + mheightm_iqr + tbc + wtkg1_iqr + biomass + Diarrhea + toilet_S +
    new_mage_cat + kchnloc1 + sga  + 
    ChldUn5  + 
    lqdbfrm  + pm1_7d+ pm2_7d + pm3_7d + pm4_7d +
   ns(month,df= 6) +
    cluster(C_ID) + 
   strata(at_risk_for),
  data = final_df,
  method = "breslow"
)

summary(pwp_gtfinal_pw_7d)
AIC(pwp_gtfinal_pw_7d)
```

#### Frailty Model 

###### Final models for Gamma and Gaussian frality 

```{r}
# Gamma
frailty_gammafinal_pw_7d <- coxph(
  Surv(tstop, status) ~ 
    sex + area + mheightm_iqr + tbc + wtkg1_iqr + biomass + Diarrhea + toilet_S +
    new_mage_cat + kchnloc1 + sga  + 
    ChldUn5  + 
    lqdbfrm  + pm1_7d+ pm2_7d + pm3_7d + pm4_7d +
    ns(month,df= 6) +
    frailty(C_ID),
  data = final_df
)

# Gaussian
frailty_gaussianfinal_pw_7d <- coxph(
  Surv(tstop, status) ~ 
    sex + area + mheightm_iqr + tbc + wtkg1_iqr + biomass + Diarrhea + toilet_S +
    new_mage_cat + kchnloc1 + sga  + 
    ChldUn5  + 
    lqdbfrm  + pm1_7d+ pm2_7d + pm3_7d + pm4_7d +
    ns(month,df= 6) +
    frailty.gaussian(C_ID),
  data = final_df
)


summary(frailty_gammafinal_pw_7d)
AIC(frailty_gammafinal_pw_7d)
summary(frailty_gaussianfinal_pw_7d)
AIC(frailty_gaussianfinal_pw_7d)
```

#### Model Diagnostics and Figure Outputs

HR table with the p values of each variables 
```{r}
extract_model_performance <- function(model, model_name) {
  data.frame(
    Model = model_name,
    N = model$n,
    N_events = model$nevent,
    AIC = AIC(model),
    Concordance = summary(model)$concordance[1],
    Concordance_SE = summary(model)$concordance[2]
  )
}


performance_table <- bind_rows(
  extract_model_performance(agfinal_pw_7d, "AG"),
  extract_model_performance(pwp_ttfinal_pw_7d, "PWP-TT"),
  extract_model_performance(pwp_gtfinal_pw_7d, "PWP-GT"),
  extract_model_performance(frailty_gammafinal_pw_7d, "Frailty-Gamma"),
  extract_model_performance(frailty_gaussianfinal_pw_7d, "Frailty-Gaussian")
)

kable(performance_table,
      digits = 3,
      col.names = c("Model", "N", "Events", "AIC", "C-index", "SE"),
      caption = "Model Performance Summary")

gt_tbl1 <- gt(performance_table)

# gtsave(gt_tbl1, "performance_table.png", vwidth = 2200, vheight = 1200)
```

```{r}
# Extract HR table 
extract_hr_table <- function(model, model_name) {
  tidy(model, exponentiate = TRUE, conf.int = TRUE) %>%
    mutate(Model = model_name) %>%
    select(Model, term, HR = estimate, 
           CI_lower = conf.low, CI_upper = conf.high, 
           p.value) %>%
    mutate(
      HR_CI = sprintf("%.2f (%.2f-%.2f)", HR, CI_lower, CI_upper),
      Significance = case_when(
        p.value < 0.001 ~ "***",
        p.value < 0.01 ~ "**",
        p.value < 0.05 ~ "*",
        p.value < 0.1 ~ ".",
        TRUE ~ ""
      )
    )
}

# extract HR for all models 
hr_all_models <- bind_rows(
  extract_hr_table(agfinal_pw_7d, "AG"),
  extract_hr_table(pwp_ttfinal_pw_7d, "PWP-TT"),
  extract_hr_table(pwp_gtfinal_pw_7d, "PWP-GT"),
  extract_hr_table(frailty_gammafinal_pw_7d, "Frailty-Gamma"),
  extract_hr_table(frailty_gaussianfinal_pw_7d, "Frailty-Gaussian")
)


hr_wide <- hr_all_models %>%
  select(Model, term, HR_CI, p.value, Significance) %>%
  pivot_wider(
    names_from = Model,
    values_from = c(HR_CI, p.value, Significance),
    names_glue = "{Model}_{.value}"
  )


hr_table <- gt(hr_wide) %>%
  tab_header(
    title = "Hazard Ratios Across Models"
  ) %>%
  fmt_number(
    columns = everything(),
    decimals = 3
  )


hr_table <- gt(hr_wide) %>%
  tab_header(title = "Hazard Ratios Across Models") %>%
  fmt_number(columns = where(is.numeric), decimals = 3)


hr_table

# gtsave(hr_table, "hr_table.png", vwidth = 2200, vheight = 1200)
```

```{r}
all_covariates <- c(
  "sex2",
  "areaSaidpur",
  "mheightm_iqr",
  "tbcoral tobacco consumtion",
  "wtkg1_iqr",
  "biomass",
  "Diarrhea1",
  "toilet_S1",
  "new_mage_catolder",
  "kchnloc1Outdoor kitchen",
  "sga",
  "ChldUn5",
# "ga",
  "lqdbfrm1",
  "pm1_7d",
  "pm2_7d",
  "pm3_7d",
  "pm4_7d"
)

# Name the variables 
var_labels <- c(
  "sex2" = "Sex (Female)",
  "areaSaidpur" = "Area (Saidpur)",
  "mheightm_iqr" = "Maternal Height(per IQR increase)",
  "tbcoral tobacco consumtion" = "Tobacco consumption",
  "wtkg1_iqr" = "Child's Weight(per IQR increase)",
  "biomass" = "Biomass fuel use",
  "Diarrhea1" = "Diarrhea",
  "toilet_S1" = "Sanitary toilet",
  "new_mage_catolder" = "Maternal Age above 18",
  "kchnloc1Outdoor kitchen" = "Outdoor Kitchen",
  "sga" = "Small for gestational age",
  "ChldUn5" = "Child under 5 yrs old at home",
#  "ga" ="Gestational age",
  "lqdbfrm1"  = "Baby given any other liquids before breast milk",
  "pm1_7d" = "PM2.5 first segment",
  "pm2_7d" = "PM2.5 second segment",
  "pm3_7d" = "PM2.5 third segment",
  "pm4_7d" = "PM2.5 fourth segment"
)
```



AIC comparison plot 
```{r}
AIC_comparison<- ggplot(performance_table, aes(x = reorder(Model, AIC), y = AIC, fill = Model)) +
  geom_col(width = 0.6, alpha = 0.8) +
  geom_text(aes(label = round(AIC, 1)), 
            vjust = -0.5, size = 3.5, color = "black") +
  labs(
    title = "Model Comparison by AIC",
    subtitle = "Lower AIC indicates better model fit",
    x = "Model",
    y = "AIC"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    legend.position = "none",
    axis.text.x = element_text(angle = 30, hjust = 1)
  ) +
  scale_fill_brewer(palette = "Set2")

print(AIC_comparison)
```

```{r}
hr_forest_data <- hr_all_models %>%
  filter(term %in% names(var_labels)) %>%
  mutate(
    term_clean = var_labels[term],
    sig = ifelse(p.value < 0.05, "Significant", "Non-significant")
  )

# Ranking 
hr_forest_data <- hr_forest_data %>%
  mutate(term_clean = factor(term_clean, levels = rev(unique(var_labels))))

# For AG Model Only
hr_forest_data_ag <- hr_forest_data %>% 
  filter(Model == "AG") %>%
  mutate(hr_direction = ifelse(HR < 1, "Protective (HR<1)", "Risk (HR>1)"))

hr_forest_plot <- ggplot(hr_forest_data_ag, 
       aes(x = HR, y = term_clean, color = hr_direction, shape = sig)) +
  geom_point(size = 4) +
  geom_errorbarh(aes(xmin = CI_lower, xmax = CI_upper), 
                 height = 0.3, linewidth = 0.8) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "black", linewidth = 0.6) +
  scale_x_log10(
    breaks = c(0.25, 0.5, 1, 2, 4, 8),
    labels = c("0.25", "0.5", "1", "2", "4", "8")
  ) +
  scale_color_manual(
    values = c("Protective (HR<1)" = "#2166ac", "Risk (HR>1)" = "#b2182b"),
    name = "Effect Direction"
  ) +
  scale_shape_manual(
    values = c("Significant" = 16, "Non-significant" = 1),
    name = "Significance (p<0.05)"
  ) +
  labs(
    title = "Hazard Ratios - AG Model",
    subtitle = "Covariates with 95% Confidence Intervals",
    x = "Hazard Ratio",
    y = NULL
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    plot.subtitle = element_text(size = 11, color = "grey40"),
    legend.position = "bottom",
    legend.box = "vertical",
    axis.text.y = element_text(size = 10),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank()
  )

print(hr_forest_plot)
```

###### Figures for manuscript

```{r}
fig_dir <- "figures_output"
```

```{r}
# KM Plot Sex
print(km_plot_sex$plot)
ggsave(
filename = file.path(fig_dir, "KM_Plot_Sex.png"),
width = 12,
height = 8,
dpi = 300
)
```

```{r}
# AIC Comparison
print(AIC_comparison)
ggsave(
filename = file.path(fig_dir, "AIC_Comparison.png"),
width = 12,
height = 8,
dpi = 300
)
```

```{r}
# Forest Plot 
print(hr_forest_plot)
ggsave(
  filename = file.path(fig_dir, "HR_forest_plot.png"),
  width = 12,
  height = 8,
  dpi = 300
)
```

Figures for different rolling windows averages for PM25 segment
 
```{r}
# rolling windows of 6 days
tmp <- ns(final_df$mean_pm25_predicted_6d, df = 4)
attr(tmp, "knots")
# Extract knots 
k1_6d <- 56.54095
k2_6d <- 80.67910
k3_6d <- 130.93394

final_df <- final_df %>%
  mutate(
    pm1_6d = mean_pm25_predicted_6d,
    pm2_6d = (mean_pm25_predicted_6d - k1_6d) * (mean_pm25_predicted_6d >= k1_6d),
    pm3_6d = (mean_pm25_predicted_6d - k2_6d) * (mean_pm25_predicted_6d >= k2_6d),
    pm4_6d = (mean_pm25_predicted_6d - k3_6d) * (mean_pm25_predicted_6d >= k3_6d)
  )

# Piecewise linear after setting the knots as threshold
agfinal_pw_6d <- coxph(
  Surv(tstart, tstop, status) ~ 
    sex + area + mheightm_iqr + tbc + wtkg1_iqr + biomass + Diarrhea + toilet_S +
    new_mage_cat + kchnloc1 + sga  + 
    ChldUn5  +
    lqdbfrm  + pm1_6d+ pm2_6d + pm3_6d + pm4_6d +
    season +
    cluster(C_ID),
  data = final_df,
  method = "breslow"
)


summary(agfinal_pw_6d)
AIC(agfinal_pw_6d)
```
 
```{r}
# rolling windows of 5 days
tmp <- ns(final_df$mean_pm25_predicted_5d, df = 4)
attr(tmp, "knots")
# Extract knots 
k1_5d <- 56.24039
k2_5d <- 80.01472
k3_5d <- 131.20362

final_df <- final_df %>%
  mutate(
    pm1_5d = mean_pm25_predicted_5d,
    pm2_5d = (mean_pm25_predicted_5d - k1_5d) * (mean_pm25_predicted_5d >= k1_5d),
    pm3_5d = (mean_pm25_predicted_5d - k2_5d) * (mean_pm25_predicted_5d >= k2_5d),
    pm4_5d = (mean_pm25_predicted_5d - k3_5d) * (mean_pm25_predicted_5d >= k3_5d)
  )

# Piecewise linear after setting the knots as threshold
agfinal_pw_5d <- coxph(
  Surv(tstart, tstop, status) ~ 
    sex + area + mheightm_iqr + tbc + wtkg1_iqr + biomass + Diarrhea + toilet_S +
    new_mage_cat + kchnloc1 + sga  + 
    ChldUn5 +
    lqdbfrm  + pm1_5d+ pm2_5d + pm3_5d + pm4_5d +
    season +
    cluster(C_ID),
  data = final_df,
  method = "breslow"
)


summary(agfinal_pw_5d)
AIC(agfinal_pw_5d)
```
 
 
```{r}
# rolling windows of 4 days
tmp <- ns(final_df$mean_pm25_predicted_4d, df = 4)
attr(tmp, "knots")
# Extract knots 
k1_4d <- 56.02435
k2_4d <- 79.07769
k3_4d <- 128.99205

final_df <- final_df %>%
  mutate(
    pm1_4d = mean_pm25_predicted_4d,
    pm2_4d = (mean_pm25_predicted_4d - k1_4d) * (mean_pm25_predicted_4d >= k1_4d),
    pm3_4d = (mean_pm25_predicted_4d - k2_4d) * (mean_pm25_predicted_4d >= k2_4d),
    pm4_4d = (mean_pm25_predicted_4d - k3_4d) * (mean_pm25_predicted_4d >= k3_4d)
  )

# Piecewise linear after setting the knots as threshold
agfinal_pw_4d <- coxph(
  Surv(tstart, tstop, status) ~ 
    sex + area + mheightm_iqr + tbc + wtkg1_iqr + biomass + Diarrhea + toilet_S +
    new_mage_cat + kchnloc1 + sga  + 
    ChldUn5  + 
    lqdbfrm  + pm1_4d+ pm2_4d + pm3_4d + pm4_4d +
    season +
    cluster(C_ID),
  data = final_df,
  method = "breslow"
)


summary(agfinal_pw_4d)
AIC(agfinal_pw_4d)
```


```{r}
# rolling windows of 3 days
tmp <- ns(final_df$mean_pm25_predicted_3d, df = 4)
attr(tmp, "knots")
# Extract knots 
k1_3d <- 56.09894
k2_3d <- 77.01258 
k3_3d <- 128.45543

final_df <- final_df %>%
  mutate(
    pm1_3d = mean_pm25_predicted_3d,
    pm2_3d = (mean_pm25_predicted_3d - k1_3d) * (mean_pm25_predicted_3d >= k1_3d),
    pm3_3d = (mean_pm25_predicted_3d - k2_3d) * (mean_pm25_predicted_3d >= k2_3d),
    pm4_3d = (mean_pm25_predicted_3d - k3_3d) * (mean_pm25_predicted_3d >= k3_3d)
  )

# Piecewise linear after setting the knots as threshold
agfinal_pw_3d <- coxph(
  Surv(tstart, tstop, status) ~ 
    sex + area + mheightm_iqr + tbc + wtkg1_iqr + biomass + Diarrhea + toilet_S +
    new_mage_cat + kchnloc1 + sga  + 
    ChldUn5  + 
    lqdbfrm  + pm1_3d+ pm2_3d + pm3_3d + pm4_3d +
    season +
    cluster(C_ID),
  data = final_df,
  method = "breslow"
)


summary(agfinal_pw_3d)
AIC(agfinal_pw_3d)
```


```{r}
# rolling windows of 2 days
tmp <- ns(final_df$mean_pm25_predicted_2d, df = 4)
attr(tmp, "knots")
# Extract knots 
k1_2d <- 56.32169
k2_2d <- 78.70576
k3_2d <- 128.23380

final_df <- final_df %>%
  mutate(
    pm1_2d = mean_pm25_predicted_2d,
    pm2_2d = (mean_pm25_predicted_2d - k1_2d) * (mean_pm25_predicted_2d >= k1_2d),
    pm3_2d = (mean_pm25_predicted_2d - k2_2d) * (mean_pm25_predicted_2d >= k2_2d),
    pm4_2d = (mean_pm25_predicted_2d - k3_2d) * (mean_pm25_predicted_2d >= k3_2d)
  )

# Piecewise linear after setting the knots as threshold
agfinal_pw_2d <- coxph(
  Surv(tstart, tstop, status) ~ 
    sex + area + mheightm_iqr + tbc + wtkg1_iqr + biomass + Diarrhea + toilet_S +
    new_mage_cat + kchnloc1 + sga  + 
    ChldUn5  +
    lqdbfrm  + pm1_2d+ pm2_2d + pm3_2d + pm4_2d +
    season +
    cluster(C_ID),
  data = final_df,
  method = "breslow"
)


summary(agfinal_pw_2d)
AIC(agfinal_pw_2d)
```

```{r}
# rolling windows of 1 day
tmp <- ns(final_df$mean_pm25_predicted_1d, df = 4)
attr(tmp, "knots")
# Extract knots 
k1_1d <- 56.01812 
k2_1d <- 79.9758
k3_1d <- 126.25840

final_df <- final_df %>%
  mutate(
    pm1_1d = mean_pm25_predicted_1d,
    pm2_1d = (mean_pm25_predicted_1d - k1_1d) * (mean_pm25_predicted_1d >= k1_1d),
    pm3_1d = (mean_pm25_predicted_1d - k2_1d) * (mean_pm25_predicted_1d >= k2_1d),
    pm4_1d = (mean_pm25_predicted_1d - k3_1d) * (mean_pm25_predicted_1d >= k3_1d)
  )

# Piecewise linear after setting the knots as threshold
agfinal_pw_1d <- coxph(
  Surv(tstart, tstop, status) ~ 
    sex + area + mheightm_iqr + tbc + wtkg1_iqr + biomass + Diarrhea + toilet_S +
    new_mage_cat + kchnloc1 + sga  + 
    ChldUn5  + 
    lqdbfrm  + pm1_1d+ pm2_1d + pm3_1d + pm4_1d +
    season +
    cluster(C_ID),
  data = final_df,
  method = "breslow"
)


summary(agfinal_pw_1d)
AIC(agfinal_pw_1d)
```

```{r}
# Extract PM variables HR and statistics
extract_pm_results <- function(model, window_name) {
  model_summary <- summary(model)
  coef_table <- model_summary$coefficients
  pm_vars <- grep("^pm[1-4]_", rownames(coef_table), value = TRUE)
  
  results <- data.frame(
    Window = window_name,
    Variable = gsub("_[0-9]d$", "", pm_vars),
    HR = coef_table[pm_vars, "exp(coef)"],
    HR_lower = exp(coef_table[pm_vars, "coef"] - 1.96 * coef_table[pm_vars, "se(coef)"]),
    HR_upper = exp(coef_table[pm_vars, "coef"] + 1.96 * coef_table[pm_vars, "se(coef)"]),
    P_value = coef_table[pm_vars, "Pr(>|z|)"],
    stringsAsFactors = FALSE
  )
  
  results$Sig <- ifelse(results$P_value < 0.001, "***",
                 ifelse(results$P_value < 0.01, "**",
                 ifelse(results$P_value < 0.05, "*",
                 ifelse(results$P_value < 0.1, ".", ""))))
  
  return(results)
}

# Extract results from all models
pm_results <- rbind(
  extract_pm_results(agfinal_pw_7d, "7d"),
  extract_pm_results(agfinal_pw_6d, "6d"),
  extract_pm_results(agfinal_pw_5d, "5d"),
  extract_pm_results(agfinal_pw_4d, "4d"),
  extract_pm_results(agfinal_pw_3d, "3d"),
  extract_pm_results(agfinal_pw_2d, "2d"),
  extract_pm_results(agfinal_pw_1d, "1d")
)

# Add AIC values
aic_values <- data.frame(
  Window = c("7d", "6d", "5d", "4d", "3d", "2d", "1d"),
  AIC = c(AIC(agfinal_pw_7d), AIC(agfinal_pw_6d), AIC(agfinal_pw_5d), 
          AIC(agfinal_pw_4d), AIC(agfinal_pw_3d), AIC(agfinal_pw_2d), AIC(agfinal_pw_1d))
)

pm_results <- pm_results %>%
  left_join(aic_values, by = "Window")

# Format table for display
pm_table <- pm_results %>%
  mutate(
    HR = sprintf("%.3f", HR),
    P = sprintf("%.4f", P_value),
    AIC_fmt = sprintf("%.2f", AIC)
  ) %>%
  select(Window, Variable, HR, P, Sig, AIC_fmt) %>%
  arrange(Variable, Window)

knitr::kable(pm_table, align = "lccrc", col.names = c("Window", "Variable", "HR", "P", "Sig", "AIC"))

# Convert Window to ordered factor
pm_results$Window <- factor(pm_results$Window, levels = c("1d", "2d", "3d", "4d", "5d", "6d", "7d"))

# Hazard ratio forest plot across lag (rolling window) exposures
pm25_forest_plot <- ggplot(pm_results, aes(x = Window, y = HR, color = Variable)) +
  geom_point(size = 3, position = position_dodge(width = 0.5)) +
  geom_errorbar(aes(ymin = HR_lower, ymax = HR_upper), 
                width = 0.2, position = position_dodge(width = 0.5)) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
  facet_wrap(~Variable, ncol = 2, scales = "free_y") +
  theme_bw() +
  labs(title = "Hazard Ratios by Rolling Window",
       y = "Hazard Ratio (95% CI)", x = "Rolling Window") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 0))

```

```{r}
print(pm25_forest_plot)
ggsave(
filename = file.path(fig_dir, "pm25_forest_plot.png"),
width = 12,
height = 8,
dpi = 300
)
```
